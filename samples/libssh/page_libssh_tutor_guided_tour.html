

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Chapter 1: A typical SSH session &mdash; LibSSH Documentation 0.7.5 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Chapter 2: A deeper insight on authentication" href="page_libssh_tutor_authentication.html" />
    <link rel="prev" title="The Tutorial" href="page_libssh_tutorial.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> LibSSH Documentation
          

          
          </a>

          
            
            
              <div class="version">
                0.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="page_libssh_linking.html">The Linking HowTo</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="page_libssh_tutorial.html">The Tutorial</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Chapter 1: A typical SSH session</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_libssh_tutor_authentication.html">Chapter 2: A deeper insight on authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_libssh_tutor_shell.html">Chapter 3: Opening a remote shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_libssh_tutor_command.html">Chapter 4: Passing a remote command</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_libssh_tutor_sftp.html">Chapter 5: The SFTP subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_libssh_tutor_scp.html">Chapter 6: The SCP subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_libssh_tutor_forwarding.html">Chapter 7: Forwarding connections (tunnel)</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_libssh_tutor_threads.html">Chapter 8: Threads with libssh</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_libssh_tutor_todo.html">To be done</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="group_libssh.html">The libssh API</a></li>
<li class="toctree-l1"><a class="reference internal" href="group_ssh_cpp.html">The libssh C++ wrapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="group_libssh_sftp.html">The libssh SFTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="group_libssh_server.html">The libssh server API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="page_bug.html">Bug List</a></li>
<li class="toctree-l1"><a class="reference internal" href="page_deprecated.html">Deprecated List</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="global.html">Global Namespace</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LibSSH Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="page_libssh_tutorial.html">The Tutorial</a> &raquo;</li>
        
      <li>Chapter 1: A typical SSH session</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="chapter-1-a-typical-ssh-session">
<span id="doxid-libssh-tutor-guided-tour"></span><span id="index-0"></span><h1>Chapter 1: A typical SSH session</h1>
<p class="rubric" id="doxid-libssh-tutor-guided-tour-1ssh-session">A typical SSH session:</p>
<p>A SSH session goes through the following steps:</p>
<ul class="simple">
<li>Before connecting to the server, you can set up if you wish one or other server public key authentication, i.e. DSA or RSA. You can choose cryptographic algorithms you trust and compression algorithms if any. You must of course set up the hostname.</li>
<li>The connection is established. A secure handshake is made, and resulting from it, a public key from the server is gained. You MUST verify that the public key is legitimate, using for instance the MD5 fingerprint or the known hosts file.</li>
<li>The client must authenticate: the classical ways are password, or public keys (from dsa and rsa key-pairs generated by openssh). If a SSH agent is running, it is possible to use it.</li>
<li>Now that the user has been authenticated, you must open one or several channels. Channels are different subways for information into a single ssh connection. Each channel has a standard stream (stdout) and an error stream (stderr). You can theoretically open an infinity of channels.</li>
<li>With the channel you opened, you can do several things:<ul>
<li>Execute a single command.</li>
<li>Open a shell. You may want to request a pseudo-terminal before.</li>
<li>Invoke the sftp subsystem to transfer files.</li>
<li>Invoke the scp subsystem to transfer files.</li>
<li>Invoke your own subsystem. This is outside the scope of this document, but can be done.</li>
</ul>
</li>
<li>When everything is finished, just close the channels, and then the connection.</li>
</ul>
<p>The sftp and scp subsystems use channels, but libssh hides them to the programmer. If you want to use those subsystems, instead of a channel, you’ll usually open a “sftp session” or a “scp session”.</p>
<p class="rubric" id="doxid-libssh-tutor-guided-tour-1setup">Creating the session and setting options:</p>
<p>The most important object in a SSH connection is the SSH session. In order to allocate a new SSH session, you use <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaadadc0f9601547c30db7c4d62017d32c"><span class="std std-ref">ssh_new()</span></a> . Don’t forget to always verify that the allocation successed.</p>
<pre class="highlight literal-block">
<span></span><span class="cp">#include</span> <span class="cpf">&lt;libssh/libssh.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">ssh_session</span> <span class="n">my_ssh_session</span> <span class="o">=</span> <span class="n">ssh_new</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">my_ssh_session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">...</span>
  <span class="n">ssh_free</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>libssh follows the allocate-it-deallocate-it pattern. Each object that you allocate using xxxxx_new() must be deallocated using xxxxx_free(). In this case, <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaadadc0f9601547c30db7c4d62017d32c"><span class="std std-ref">ssh_new()</span></a> does the allocation and <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gae5af27a98a7488e9f5ded6b37c274156"><span class="std std-ref">ssh_free()</span></a> does the contrary.</p>
<p>The <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga7a801b85800baa3f4e16f5b47db0a73d"><span class="std std-ref">ssh_options_set()</span></a> function sets the options of the session. The most important options are:</p>
<ul class="simple">
<li>SSH_OPTIONS_HOST: the name of the host you want to connect to</li>
<li>SSH_OPTIONS_PORT: the used port (default is port 22)</li>
<li>SSH_OPTIONS_USER: the system user under which you want to connect</li>
<li>SSH_OPTIONS_LOG_VERBOSITY: the quantity of messages that are printed</li>
</ul>
<p>The complete list of options can be found in the documentation of <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga7a801b85800baa3f4e16f5b47db0a73d"><span class="std std-ref">ssh_options_set()</span></a> . The only mandatory option is SSH_OPTIONS_HOST. If you don’t use SSH_OPTIONS_USER, the local username of your account will be used.</p>
<p>Here is a small example of how to use it:</p>
<pre class="highlight literal-block">
<span></span><span class="cp">#include</span> <span class="cpf">&lt;libssh/libssh.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">ssh_session</span> <span class="n">my_ssh_session</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">SSH_LOG_PROTOCOL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>

  <span class="n">my_ssh_session</span> <span class="o">=</span> <span class="n">ssh_new</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">my_ssh_session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">ssh_options_set</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">,</span> <span class="n">SSH_OPTIONS_HOST</span><span class="p">,</span> <span class="s">&quot;localhost&quot;</span><span class="p">);</span>
  <span class="n">ssh_options_set</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">,</span> <span class="n">SSH_OPTIONS_LOG_VERBOSITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">verbosity</span><span class="p">);</span>
  <span class="n">ssh_options_set</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">,</span> <span class="n">SSH_OPTIONS_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>

  <span class="p">...</span>

  <span class="n">ssh_free</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>Please notice that all parameters are passed to <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga7a801b85800baa3f4e16f5b47db0a73d"><span class="std std-ref">ssh_options_set()</span></a> as pointers, even if you need to set an integer value.</p>
<p class="rubric" id="doxid-libssh-tutor-guided-tour-1connect">Connecting to the server:</p>
<p>Once all settings have been made, you can connect using <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga032e07cbd8bc3f14cb2dd375db0b03d7"><span class="std std-ref">ssh_connect()</span></a> . That function will return SSH_OK if the connection worked, SSH_ERROR otherwise.</p>
<p>You can get the English error string with <a class="reference internal" href="group_libssh_error.html#doxid-group-libssh-error-1ga9241586665bf21f823806473fc386258"><span class="std std-ref">ssh_get_error()</span></a> in order to show the user what went wrong. Then, use <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga0f048a4c0dbe02cfb7e9c5b6d0db0f27"><span class="std std-ref">ssh_disconnect()</span></a> when you want to stop the session.</p>
<p>Here’s an example:</p>
<pre class="highlight literal-block">
<span></span><span class="cp">#include</span> <span class="cpf">&lt;libssh/libssh.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">ssh_session</span> <span class="n">my_ssh_session</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

  <span class="n">my_ssh_session</span> <span class="o">=</span> <span class="n">ssh_new</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">my_ssh_session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">ssh_options_set</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">,</span> <span class="n">SSH_OPTIONS_HOST</span><span class="p">,</span> <span class="s">&quot;localhost&quot;</span><span class="p">);</span>

  <span class="n">rc</span> <span class="o">=</span> <span class="n">ssh_connect</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SSH_OK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error connecting to localhost: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ssh_get_error</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">));</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">...</span>

  <span class="n">ssh_disconnect</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
  <span class="n">ssh_free</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p class="rubric" id="doxid-libssh-tutor-guided-tour-1serverauth">Authenticating the server:</p>
<p>Once you’re connected, the following step is mandatory: you must check that the server you just connected to is known and safe to use (remember, SSH is about security and authentication).</p>
<p>There are two ways of doing this:</p>
<ul class="simple">
<li>The first way (recommended) is to use the <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga6f37e3d7bb6b938b44d6a34a76fdfa0b"><span class="std std-ref">ssh_is_server_known()</span></a> function. This function will look into the known host file (~/.ssh/known_hosts on UNIX), look for the server hostname’s pattern, and determine whether this host is present or not in the list.</li>
<li>The second way is to use <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaf8ff0e2236d54d964a82f68d7323a741"><span class="std std-ref">ssh_get_pubkey_hash()</span></a> to get a binary version of the public key hash value. You can then use your own database to check if this public key is known and secure.</li>
</ul>
<p>You can also use the <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaf8ff0e2236d54d964a82f68d7323a741"><span class="std std-ref">ssh_get_pubkey_hash()</span></a> to show the public key hash value to the user, in case he knows what the public key hash value is (some paranoid people write their public key hash values on paper before going abroad, just in case …).</p>
<p>If the remote host is being used to for the first time, you can ask the user whether he/she trusts it. Once he/she concluded that the host is valid and worth being added in the known hosts file, you use <a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaf61a9cfdc40c76ffce9f9a8543755d36"><span class="std std-ref">ssh_write_knownhost()</span></a> to register it in the known hosts file, or any other way if you use your own database.</p>
<p>The following example is part of the examples suite available in the examples/ directory:</p>
<pre class="highlight literal-block">
<span></span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">verify_knownhost</span><span class="p">(</span><span class="n">ssh_session</span> <span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">hlen</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">hexa</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

  <span class="n">state</span> <span class="o">=</span> <span class="n">ssh_is_server_known</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

  <span class="n">hlen</span> <span class="o">=</span> <span class="n">ssh_get_pubkey_hash</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hash</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="nl">SSH_SERVER_KNOWN_OK</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span> <span class="cm">/* ok */</span>

    <span class="k">case</span> <span class="nl">SSH_SERVER_KNOWN_CHANGED</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Host key for server changed: it is now:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">ssh_print_hexa</span><span class="p">(</span><span class="s">&quot;Public key hash&quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;For security reasons, connection will be stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">SSH_SERVER_FOUND_OTHER</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;The host key for this server was not found but an other&quot;</span>
        <span class="s">&quot;type of key exists.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;An attacker might change the default server key to&quot;</span>
        <span class="s">&quot;confuse your client into thinking the key does not exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">SSH_SERVER_FILE_NOT_FOUND</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Could not find known host file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;If you accept the host key here, the file will be&quot;</span>
       <span class="s">&quot;automatically created.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="cm">/* fallback to SSH_SERVER_NOT_KNOWN behavior */</span>

    <span class="k">case</span> <span class="nl">SSH_SERVER_NOT_KNOWN</span><span class="p">:</span>
      <span class="n">hexa</span> <span class="o">=</span> <span class="n">ssh_get_hexa</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">hlen</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;The server is unknown. Do you trust the host key?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Public key hash: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hexa</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">hexa</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ssh_write_knownhost</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">free</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">SSH_SERVER_ERROR</span><span class="p">:</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error %s&quot;</span><span class="p">,</span> <span class="n">ssh_get_error</span><span class="p">(</span><span class="n">session</span><span class="p">));</span>
      <span class="n">free</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">free</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p class="rubric" id="doxid-libssh-tutor-guided-tour-1auth">Authenticating the user:</p>
<p>The authentication process is the way a service provider can identify a user and verify his/her identity. The authorization process is about enabling the authenticated user the access to ressources. In SSH, the two concepts are linked. After authentication, the server can grant the user access to several ressources such as port forwarding, shell, sftp subsystem, and so on.</p>
<p>libssh supports several methods of authentication:</p>
<ul class="simple">
<li>“none” method. This method allows to get the available authentications methods. It also gives the server a chance to authenticate the user with just his/her login. Some very old hardware uses this feature to fallback the user on a “telnet over SSH” style of login.</li>
<li>password method. A password is sent to the server, which accepts it or not.</li>
<li>keyboard-interactive method. The server sends several challenges to the user, who must answer correctly. This makes possible the authentication via a codebook for instance (“give code at 23:R on page 3”).</li>
<li>public key method. The host knows the public key of the user, and the user must prove he knows the associated private key. This can be done manually, or delegated to the SSH agent as we’ll see later.</li>
</ul>
<p>All these methods can be combined. You can for instance force the user to authenticate with at least two of the authentication methods. In that case, one speaks of “Partial authentication”. A partial authentication is a response from authentication functions stating that your credential was accepted, but yet another one is required to get in.</p>
<p>The example below shows an authentication with password:</p>
<pre class="highlight literal-block">
<span></span><span class="cp">#include</span> <span class="cpf">&lt;libssh/libssh.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">ssh_session</span> <span class="n">my_ssh_session</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">;</span>

  <span class="c1">// Open session and set options</span>
  <span class="n">my_ssh_session</span> <span class="o">=</span> <span class="n">ssh_new</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">my_ssh_session</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">ssh_options_set</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">,</span> <span class="n">SSH_OPTIONS_HOST</span><span class="p">,</span> <span class="s">&quot;localhost&quot;</span><span class="p">);</span>

  <span class="c1">// Connect to server</span>
  <span class="n">rc</span> <span class="o">=</span> <span class="n">ssh_connect</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SSH_OK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error connecting to localhost: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ssh_get_error</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">));</span>
    <span class="n">ssh_free</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Verify the server&#39;s identity</span>
  <span class="c1">// For the source code of verify_knowhost(), check previous example</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">verify_knownhost</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ssh_disconnect</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
    <span class="n">ssh_free</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Authenticate ourselves</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s">&quot;Password: &quot;</span><span class="p">);</span>
  <span class="n">rc</span> <span class="o">=</span> <span class="n">ssh_userauth_password</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SSH_AUTH_SUCCESS</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error authenticating with password: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ssh_get_error</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">));</span>
    <span class="n">ssh_disconnect</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
    <span class="n">ssh_free</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">...</span>

  <span class="n">ssh_disconnect</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
  <span class="n">ssh_free</span><span class="p">(</span><span class="n">my_ssh_session</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p class="rubric" id="doxid-libssh-tutor-guided-tour-1using-ssh">Doing something:</p>
<p>At this point, the authenticity of both server and client is established. Time has come to take advantage of the many possibilities offered by the SSH protocol: execute a remote command, open remote shells, transfer files, forward ports, etc.</p>
<p>The example below shows how to execute a remote command:</p>
<pre class="highlight literal-block">
<span></span><span class="kt">int</span> <span class="nf">show_remote_processes</span><span class="p">(</span><span class="n">ssh_session</span> <span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ssh_channel</span> <span class="n">channel</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">nbytes</span><span class="p">;</span>

  <span class="n">channel</span> <span class="o">=</span> <span class="n">ssh_channel_new</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SSH_ERROR</span><span class="p">;</span>

  <span class="n">rc</span> <span class="o">=</span> <span class="n">ssh_channel_open_session</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SSH_OK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ssh_channel_free</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">rc</span> <span class="o">=</span> <span class="n">ssh_channel_request_exec</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="s">&quot;ps aux&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SSH_OK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ssh_channel_close</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
    <span class="n">ssh_channel_free</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">nbytes</span> <span class="o">=</span> <span class="n">ssh_channel_read</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">nbytes</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">ssh_channel_close</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
      <span class="n">ssh_channel_free</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">SSH_ERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">nbytes</span> <span class="o">=</span> <span class="n">ssh_channel_read</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ssh_channel_close</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
    <span class="n">ssh_channel_free</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">SSH_ERROR</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ssh_channel_send_eof</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
  <span class="n">ssh_channel_close</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
  <span class="n">ssh_channel_free</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">SSH_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p class="rubric" id="doxid-libssh-tutor-guided-tour-1errors">Handling the errors:</p>
<p>All the libssh functions which return an error value also set an English error message describing the problem.</p>
<p>Error values are typically SSH_ERROR for integer values, or NULL for pointers.</p>
<p>The function <a class="reference internal" href="group_libssh_error.html#doxid-group-libssh-error-1ga9241586665bf21f823806473fc386258"><span class="std std-ref">ssh_get_error()</span></a> returns a pointer to the static error message.</p>
<p>ssh_error_code() returns the error code number : SSH_NO_ERROR, SSH_REQUEST_DENIED, SSH_INVALID_REQUEST, SSH_CONNECTION_LOST, SSH_FATAL, or SSH_INVALID_DATA. SSH_REQUEST_DENIED means the ssh server refused your request, but the situation is recoverable. The others mean something happened to the connection (some encryption problems, server problems, …). SSH_INVALID_REQUEST means the library got some garbage from server, but might be recoverable. SSH_FATAL means the connection has an important problem and isn’t probably recoverable.</p>
<p>Most of time, the error returned are SSH_FATAL, but some functions (generaly the ssh_request_xxx ones) may fail because of server denying request. In these cases, SSH_REQUEST_DENIED is returned.</p>
<p>For thread safety, errors are bound to ssh_session objects. As long as your ssh_session object is not NULL, you can retrieve the last error message and error code from the ssh_session using <a class="reference internal" href="group_libssh_error.html#doxid-group-libssh-error-1ga9241586665bf21f823806473fc386258"><span class="std std-ref">ssh_get_error()</span></a> and <a class="reference internal" href="group_libssh_error.html#doxid-group-libssh-error-1ga036433b7bf3d4ca94206253f58d136f9"><span class="std std-ref">ssh_get_error_code()</span></a> respectively.</p>
<p>The SFTP subsystem has its own error codes, in addition to libssh ones.</p>
<p class="rubric">See also:</p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaadadc0f9601547c30db7c4d62017d32c"><span class="std std-ref">ssh_new</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gae5af27a98a7488e9f5ded6b37c274156"><span class="std std-ref">ssh_free</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga7a801b85800baa3f4e16f5b47db0a73d"><span class="std std-ref">ssh_options_set</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga82371e723260c7572ea061edecc2e9f1"><span class="std std-ref">ssh_options_parse_config</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaead8cef1f39e785139bc510852ce1dff"><span class="std std-ref">ssh_options_copy</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga93f7f7159893f3ce62c9b178724eff75"><span class="std std-ref">ssh_options_getopt</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga032e07cbd8bc3f14cb2dd375db0b03d7"><span class="std std-ref">ssh_connect</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga0f048a4c0dbe02cfb7e9c5b6d0db0f27"><span class="std std-ref">ssh_disconnect</span></a></p>
<p><a class="reference internal" href="group_libssh_error.html#doxid-group-libssh-error-1ga9241586665bf21f823806473fc386258"><span class="std std-ref">ssh_get_error</span></a></p>
<p><a class="reference internal" href="group_libssh_error.html#doxid-group-libssh-error-1ga036433b7bf3d4ca94206253f58d136f9"><span class="std std-ref">ssh_get_error_code</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaf8ff0e2236d54d964a82f68d7323a741"><span class="std std-ref">ssh_get_pubkey_hash</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1ga6f37e3d7bb6b938b44d6a34a76fdfa0b"><span class="std std-ref">ssh_is_server_known</span></a></p>
<p><a class="reference internal" href="group_libssh_session.html#doxid-group-libssh-session-1gaf61a9cfdc40c76ffce9f9a8543755d36"><span class="std std-ref">ssh_write_knownhost</span></a></p>
<p><a class="reference internal" href="page_libssh_tutor_authentication.html#doxid-libssh-tutor-authentication-1authentication-details"><span class="std std-ref">A deeper insight on authentication</span></a></p>
<p><a class="reference internal" href="page_libssh_tutor_shell.html#doxid-libssh-tutor-shell-1opening-shell"><span class="std std-ref">Opening a remote shell</span></a></p>
<p><a class="reference internal" href="page_libssh_tutor_command.html#doxid-libssh-tutor-command-1remote-command"><span class="std std-ref">Passing a remote command</span></a></p>
<p><a class="reference internal" href="page_libssh_tutor_sftp.html#doxid-libssh-tutor-sftp-1sftp-subsystem"><span class="std std-ref">The SFTP subsystem</span></a></p>
<p><a class="reference internal" href="page_libssh_tutor_scp.html#doxid-libssh-tutor-scp-1scp-subsystem"><span class="std std-ref">The SCP subsystem</span></a></p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="page_libssh_tutor_authentication.html" class="btn btn-neutral float-right" title="Chapter 2: A deeper insight on authentication" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="page_libssh_tutorial.html" class="btn btn-neutral" title="The Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2003-2017, LibSSH Maintainers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'0.7.5',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>